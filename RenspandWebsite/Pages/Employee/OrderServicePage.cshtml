@page
@using RenSpand_Eksamensprojekt
@model RenspandWebsite.Pages.Employee.OrderServicePageModel
<link rel="stylesheet" href="~/css/OrderServiceStyleSheet.css" asp-append-version="true" />

<h1>Ordreliste</h1>

<form method="post" asp-page-handler="Search"  class="search-form">
    <input type="text" name="searchTerm" value="@Model.SearchTerm" placeholder="Søg efter navn, telefon eller adresse..." class="search-input" />
    <button type="submit" class="search-button">Søg</button>
</form>

@if (Model.Orders.Count <= 0)
{
    <p>Ingen ordrer fundet.</p>
}
else
{
    <table class="order-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Køber</th>
                <th>Services</th>
                <th>Adresse</th>
                <th>Pris</th>
                <th>Startdato</th>
                <th>Slutdato</th>
                <th>Status</th>
                <th>Noter (Medarbejder)</th>
                <th>Noter (Bruger)</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var order in Model.Orders)
            {
                var rowClass = order.AcceptStatus switch
                {
                    AcceptStatusEnum.Pending => "status-pending",
                    AcceptStatusEnum.Accepted => "status-accepted",
                    AcceptStatusEnum.Rejected => "status-rejected",
                    _ => "status-unknown"
                };

                <tr class="@rowClass">
                    <td>@order.Id</td>
                    <td>@order.Buyer?.Name</td>
                    <td>
                        @foreach (var service in order.ServiceItems)
                        {
                            <span>@service.ServiceWork?.Name</span>
                            <br />
                        }
                    </td>
                    <td>
                         @foreach (var address in order.AddressItems)
                         {
                             <span>@address.Address.Street, @address.Address.City, @address.Address.ZipCode</span>

                             <br />
                        }
                    </td>
                    <td>@order.TotalPrice.ToString("C")</td>
                    <td>@order.DateStart.ToString("dd-MM-yyyy")</td>
                    <td>@order.DateDone.ToString("dd-MM-yyyy")</td>
                    <td>
                        @if (order.AcceptStatus == AcceptStatusEnum.Pending)
                        {
                            <form method="post" asp-page-handler="AcceptOrder">
                                <input type="hidden" name="orderId" value="@order.Id" />
                                <button class="btn btn-success btn-sm" type="submit" title="Accept">
                                    <i class="fa fa-check"></i> Accept
                                </button>
                            </form>

                            <form method="post" asp-page-handler="RejectOrder">
                                <input type="hidden" name="orderId" value="@order.Id" />
                                <button class="btn btn-danger btn-sm" type="submit" title="Reject">
                                    <i class="fa fa-trash"></i> Reject
                                </button>
                            </form>
                        }

                    </td>
                    <td>
                        <form method="post" asp-page-handler="ToggleDone">
                            <input type="hidden" name="orderId" value="@order.Id" />
                            <button type="submit" class="btn btn-sm @(order.IsDone ? "btn-success" : "btn-warning")">
                                @(order.IsDone ? "Færdig" : "Ikke færdig - klik for at færdiggøre")
                            </button>
                        </form>
                    </td>
                    <td>
                        <form method="post" asp-page-handler="SaveNote">
                            <input type="hidden" name="orderId" value="@order.Id" />
                            <textarea name="note" class="form-control">@order.EmployeeNote</textarea>
                            <button class="btn btn-primary btn-sm mt-1" type="submit">Save Notes</button>
                        </form>
                    </td>
                    <td>
                        <textarea class="form-control" readonly>@order.CustomerNote</textarea>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}